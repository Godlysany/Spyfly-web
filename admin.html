<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpyFly Admin - Prize Management</title>
    <link rel="stylesheet" href="styles.css?v=202509">
    <style>
        .admin-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .admin-header { background: var(--darker-bg); padding: 30px; border-radius: 12px; margin-bottom: 30px; text-align: center; }
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .admin-card { background: var(--darker-bg); border-radius: 12px; padding: 25px; border: 1px solid rgba(45, 212, 127, 0.3); }
        .admin-card h3 { color: var(--primary-color); margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; color: #ffffff; margin-bottom: 8px; font-weight: 600; }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; 
            background: var(--dark-bg); 
            border: 1px solid rgba(45, 212, 127, 0.3); 
            border-radius: 6px; 
            padding: 12px; 
            color: #ffffff; 
            font-size: 14px;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        .btn-admin { background: var(--primary-color); color: #ffffff; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-right: 10px; }
        .btn-admin:hover { background: #22c55e; }
        .btn-danger { background: #dc2626; }
        .btn-danger:hover { background: #b91c1c; }
        .competition-list { max-height: 400px; overflow-y: auto; }
        .competition-item { 
            background: rgba(45, 212, 127, 0.1); 
            border: 1px solid rgba(45, 212, 127, 0.3); 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 15px; 
        }
        .competition-status { 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 12px; 
            font-weight: 600;
        }
        .status-active { background: #dc2626; color: white; }
        .status-upcoming { background: var(--purple-color); color: white; }
        .status-ended { background: #6b7280; color: white; }
        .stats-row { display: flex; justify-content: space-between; margin-top: 10px; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 1.2rem; font-weight: 700; color: var(--primary-color); }
        .stat-label { font-size: 0.9rem; color: #ffffff; opacity: 0.8; }
        .loading { text-align: center; padding: 40px; color: var(--primary-color); }
        .error { background: #dc2626; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .success { background: #22c55e; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        @media (max-width: 768px) { 
            .admin-grid { grid-template-columns: 1fr; }
            .admin-container { padding: 15px; }
        }
    </style>
</head>
<body class="admin-page" style="background: var(--dark-bg); color: #ffffff; min-height: 100vh;">
    <!-- Authentication Check Overlay -->
    <div id="auth-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 18, 19, 0.95); display: flex; align-items: center; justify-content: center; z-index: 9999;">
        <div style="text-align: center; color: #2DD47F;">
            <div class="loading" style="width: 40px; height: 40px; margin: 0 auto 20px;"></div>
            <h2>üîê Verifying Access</h2>
            <p>Please wait while we authenticate your session...</p>
        </div>
    </div>
    
    <div class="admin-container" id="admin-content" style="display: none;">
        <div class="admin-header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div>
                    <h1>üèÜ SpyFly Prize Management</h1>
                    <p>Manage competitions, prizes, and winners</p>
                </div>
                <div style="text-align: right;">
                    <p style="margin: 0; color: #2DD47F; font-size: 14px;">Welcome, <span id="admin-username">admin</span></p>
                    <button onclick="logout()" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; margin-top: 5px;">Logout</button>
                </div>
            </div>
            <div id="connection-status" class="loading">Connecting to database...</div>
        </div>

        <div id="message-area"></div>

        <div class="admin-grid">
            <!-- Create New Competition -->
            <div class="admin-card">
                <h3>üéØ Create New Competition</h3>
                <form id="competition-form">
                    <div class="form-group">
                        <label>Competition Name (ID)</label>
                        <input type="text" id="comp-name" placeholder="e.g., oct2025" required>
                    </div>
                    <div class="form-group">
                        <label>Display Title</label>
                        <input type="text" id="comp-title" placeholder="e.g., October Trading Championship" required>
                    </div>
                    <div class="form-group">
                        <label>Period Display</label>
                        <input type="text" id="comp-period" placeholder="e.g., October 2025" required>
                    </div>
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="datetime-local" id="comp-start" required>
                    </div>
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="datetime-local" id="comp-end" required>
                    </div>
                    <div class="form-group">
                        <label>Prize Pool (USD)</label>
                        <input type="number" id="comp-pool" placeholder="15000" required>
                    </div>
                    <div class="form-group">
                        <label>Hero Banner Text</label>
                        <input type="text" id="comp-highlight" placeholder="üî• $15K Prize Pool - Ends This Month!">
                    </div>
                    <div class="form-group">
                        <label>CTA Button Text</label>
                        <input type="text" id="comp-cta-text" placeholder="JOIN COMPETITION">
                    </div>
                    <div class="form-group">
                        <label>CTA Link</label>
                        <input type="url" id="comp-cta-link" placeholder="leaderboard.html#prize-hub">
                    </div>
                    
                    <!-- Prize Breakdown Section -->
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 10px;">üèÜ Prize Breakdown</label>
                        <div id="prize-breakdown-container">
                            <div class="prize-breakdown-item" style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                                <input type="text" placeholder="1st" style="width: 80px;" class="breakdown-place" value="1st">
                                <input type="number" placeholder="7500" style="width: 100px;" class="breakdown-amount" value="">
                                <span style="color: #888;">USD</span>
                                <input type="number" placeholder="50" style="width: 80px;" class="breakdown-percent" value="50" min="1" max="100">
                                <span style="color: #888;">%</span>
                                <button type="button" onclick="removePrizeItem(this)" style="background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">‚úï</button>
                            </div>
                            <div class="prize-breakdown-item" style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                                <input type="text" placeholder="2nd" style="width: 80px;" class="breakdown-place" value="2nd">
                                <input type="number" placeholder="4500" style="width: 100px;" class="breakdown-amount" value="">
                                <span style="color: #888;">USD</span>
                                <input type="number" placeholder="30" style="width: 80px;" class="breakdown-percent" value="30" min="1" max="100">
                                <span style="color: #888;">%</span>
                                <button type="button" onclick="removePrizeItem(this)" style="background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">‚úï</button>
                            </div>
                            <div class="prize-breakdown-item" style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                                <input type="text" placeholder="3rd" style="width: 80px;" class="breakdown-place" value="3rd">
                                <input type="number" placeholder="3000" style="width: 100px;" class="breakdown-amount" value="">
                                <span style="color: #888;">USD</span>
                                <input type="number" placeholder="20" style="width: 80px;" class="breakdown-percent" value="20" min="1" max="100">
                                <span style="color: #888;">%</span>
                                <button type="button" onclick="removePrizeItem(this)" style="background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">‚úï</button>
                            </div>
                        </div>
                        <button type="button" onclick="addPrizeItem()" class="btn-admin" style="background: #2DD47F; margin-top: 10px;">+ Add Prize Place</button>
                        <button type="button" onclick="autoCalculatePrizes()" class="btn-admin" style="background: #9945ff; margin-top: 10px;">‚ö° Auto-Calculate from Pool</button>
                    </div>
                    
                    <button type="submit" class="btn-admin">Create Competition</button>
                </form>
            </div>

            <!-- Existing Competitions -->
            <div class="admin-card">
                <h3>üìã Existing Competitions</h3>
                <div id="competitions-list" class="competition-list">
                    <div class="loading">Loading competitions...</div>
                </div>
                <button class="btn-admin" onclick="loadCompetitions()">Refresh List</button>
            </div>

            <!-- Add Winners -->
            <div class="admin-card">
                <h3>üèÜ Add Competition Winners</h3>
                <form id="winner-form">
                    <div class="form-group">
                        <label>Competition</label>
                        <select id="winner-competition" required>
                            <option value="">Select Competition</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Position</label>
                        <input type="number" id="winner-place" min="1" placeholder="1" required>
                    </div>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="winner-username" placeholder="@crypto_wizard" required>
                    </div>
                    <div class="form-group">
                        <label>Amount Won (USD)</label>
                        <input type="number" id="winner-amount" placeholder="7500" required>
                    </div>
                    <div class="form-group">
                        <label>Transaction URL (Optional)</label>
                        <input type="url" id="winner-tx" placeholder="https://solscan.io/tx/...">
                    </div>
                    <button type="submit" class="btn-admin">Add Winner</button>
                </form>
            </div>

            <!-- Winners Management -->
            <div class="admin-card">
                <h3>üèÜ Manage Winners</h3>
                <div id="winners-list" style="max-height: 400px; overflow-y: auto;">
                    <div class="loading">Loading winners...</div>
                </div>
                <button class="btn-admin" onclick="loadWinners()" style="margin-top: 15px;">Refresh Winners</button>
            </div>

            <!-- System Stats -->
            <div class="admin-card">
                <h3>üìä System Statistics</h3>
                <div id="system-stats">
                    <div class="loading">Loading stats...</div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label>Cache Version (bump to refresh frontend)</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="cache-version" placeholder="202509">
                        <button class="btn-admin" onclick="updateCacheVersion()">Update</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let competitions = [];

        // Authentication variables
        let authToken = null;
        let currentAdmin = null;

        // Authentication functions
        async function checkAuthentication() {
            const token = localStorage.getItem('spyfly_admin_token');
            
            if (!token) {
                redirectToLogin();
                return false;
            }
            
            try {
                const response = await fetch('/api/admin/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = token;
                    currentAdmin = data.admin;
                    
                    // Update UI with admin info
                    document.getElementById('admin-username').textContent = currentAdmin.username;
                    document.getElementById('auth-overlay').style.display = 'none';
                    document.getElementById('admin-content').style.display = 'block';
                    
                    return true;
                } else {
                    localStorage.removeItem('spyfly_admin_token');
                    localStorage.removeItem('spyfly_admin_user');
                    redirectToLogin();
                    return false;
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                redirectToLogin();
                return false;
            }
        }
        
        function redirectToLogin() {
            window.location.href = 'login.html';
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('spyfly_admin_token');
                localStorage.removeItem('spyfly_admin_user');
                redirectToLogin();
            }
        }

        // Modified fetch function to include auth headers
        async function authenticatedFetch(url, options = {}) {
            if (!authToken) {
                redirectToLogin();
                return;
            }
            
            options.headers = {
                ...options.headers,
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            };
            
            const response = await fetch(url, options);
            
            if (response.status === 401) {
                localStorage.removeItem('spyfly_admin_token');
                localStorage.removeItem('spyfly_admin_user');
                redirectToLogin();
                return;
            }
            
            return response;
        }

        // Initialize admin panel
        document.addEventListener('DOMContentLoaded', async function() {
            // First check authentication
            const isAuthenticated = await checkAuthentication();
            if (isAuthenticated) {
                testConnection();
                loadCompetitions();
                loadSystemStats();
                loadWinners();
                
                // Setup form handlers
                document.getElementById('competition-form').addEventListener('submit', createCompetition);
                document.getElementById('winner-form').addEventListener('submit', addWinner);
            }
        });

        async function testConnection() {
            const statusEl = document.getElementById('connection-status');
            try {
                const response = await fetch('/api/test');
                if (response.ok) {
                    statusEl.innerHTML = '‚úÖ Database Connected';
                    statusEl.className = 'success';
                } else {
                    throw new Error('Connection failed');
                }
            } catch (error) {
                statusEl.innerHTML = '‚ùå Database Connection Failed';
                statusEl.className = 'error';
            }
        }

        async function loadCompetitions() {
            const listEl = document.getElementById('competitions-list');
            const selectEl = document.getElementById('winner-competition');
            
            try {
                const response = await fetch('/api/competitions');
                competitions = await response.json();
                
                // Update competitions list
                listEl.innerHTML = competitions.map(comp => {
                    const status = getCompetitionStatus(comp);
                    return `
                        <div class="competition-item">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0; color: var(--primary-color);">${comp.title}</h4>
                                    <p style="margin: 5px 0; opacity: 0.8;">${comp.period}</p>
                                </div>
                                <span class="competition-status status-${status.toLowerCase()}">${status}</span>
                            </div>
                            <div class="stats-row">
                                <div class="stat-item">
                                    <div class="stat-value">$${comp.prize_pool_usd.toLocaleString()}</div>
                                    <div class="stat-label">Prize Pool</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${new Date(comp.start_date).toLocaleDateString()}</div>
                                    <div class="stat-label">Start Date</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${new Date(comp.end_date).toLocaleDateString()}</div>
                                    <div class="stat-label">End Date</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Update winner form select
                selectEl.innerHTML = '<option value="">Select Competition</option>' + 
                    competitions.map(comp => `<option value="${comp.id}">${comp.title}</option>`).join('');
                
            } catch (error) {
                listEl.innerHTML = '<div class="error">Failed to load competitions</div>';
            }
        }

        function getCompetitionStatus(comp) {
            const now = new Date();
            const start = new Date(comp.start_date);
            const end = new Date(comp.end_date);
            
            if (now >= start && now <= end) return 'ACTIVE';
            if (now < start) return 'UPCOMING';
            return 'ENDED';
        }

        // Prize Breakdown Management Functions
        function addPrizeItem() {
            const container = document.getElementById('prize-breakdown-container');
            const newItem = document.createElement('div');
            newItem.className = 'prize-breakdown-item';
            newItem.style = 'display: flex; gap: 10px; margin-bottom: 8px; align-items: center;';
            newItem.innerHTML = `
                <input type="text" placeholder="4th" style="width: 80px;" class="breakdown-place" value="">
                <input type="number" placeholder="1000" style="width: 100px;" class="breakdown-amount" value="">
                <span style="color: #888;">USD</span>
                <input type="number" placeholder="10" style="width: 80px;" class="breakdown-percent" value="" min="1" max="100">
                <span style="color: #888;">%</span>
                <button type="button" onclick="removePrizeItem(this)" style="background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">‚úï</button>
            `;
            container.appendChild(newItem);
        }

        function removePrizeItem(button) {
            const container = document.getElementById('prize-breakdown-container');
            if (container.children.length > 1) {
                button.parentElement.remove();
            } else {
                showMessage('Must have at least one prize place', 'error');
            }
        }

        function autoCalculatePrizes() {
            const prizePool = parseInt(document.getElementById('comp-pool').value);
            if (!prizePool || prizePool <= 0) {
                showMessage('Please enter a valid prize pool first', 'error');
                return;
            }

            const items = document.querySelectorAll('.prize-breakdown-item');
            const percentages = [50, 30, 20, 15, 10, 8, 5, 3, 2, 1]; // Default distribution

            items.forEach((item, index) => {
                const amountInput = item.querySelector('.breakdown-amount');
                const percentInput = item.querySelector('.breakdown-percent');
                const percent = index < percentages.length ? percentages[index] : 1;
                const amount = Math.floor((prizePool * percent) / 100);
                
                amountInput.value = amount;
                percentInput.value = percent;
            });

            showMessage('Prize breakdown calculated automatically!', 'success');
        }

        async function createCompetition(e) {
            e.preventDefault();
            
            // Collect prize breakdown data
            const prizeBreakdown = [];
            const breakdownItems = document.querySelectorAll('.prize-breakdown-item');
            
            breakdownItems.forEach(item => {
                const place = item.querySelector('.breakdown-place').value;
                const amount = parseInt(item.querySelector('.breakdown-amount').value);
                const percent = parseInt(item.querySelector('.breakdown-percent').value);
                
                if (place && amount && percent) {
                    prizeBreakdown.push({
                        place: place,
                        amount_usd: amount,
                        percent: percent,
                        is_split: false
                    });
                }
            });

            const competition = {
                name: document.getElementById('comp-name').value,
                title: document.getElementById('comp-title').value,
                period: document.getElementById('comp-period').value,
                start_date: new Date(document.getElementById('comp-start').value).toISOString(),
                end_date: new Date(document.getElementById('comp-end').value).toISOString(),
                prize_pool_usd: parseInt(document.getElementById('comp-pool').value),
                highlight_copy: document.getElementById('comp-highlight').value,
                cta_text: document.getElementById('comp-cta-text').value,
                cta_link: document.getElementById('comp-cta-link').value,
                prize_breakdown: prizeBreakdown
            };
            
            try {
                const response = await authenticatedFetch('/api/competitions', {
                    method: 'POST',
                    body: JSON.stringify(competition)
                });
                
                if (response.ok) {
                    showMessage('Competition and prize breakdown created successfully!', 'success');
                    e.target.reset();
                    
                    // Reset prize breakdown to defaults
                    const container = document.getElementById('prize-breakdown-container');
                    container.innerHTML = `
                        <div class="prize-breakdown-item" style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                            <input type="text" placeholder="1st" style="width: 80px;" class="breakdown-place" value="1st">
                            <input type="number" placeholder="7500" style="width: 100px;" class="breakdown-amount" value="">
                            <span style="color: #888;">USD</span>
                            <input type="number" placeholder="50" style="width: 80px;" class="breakdown-percent" value="50" min="1" max="100">
                            <span style="color: #888;">%</span>
                            <button type="button" onclick="removePrizeItem(this)" style="background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">‚úï</button>
                        </div>
                        <div class="prize-breakdown-item" style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                            <input type="text" placeholder="2nd" style="width: 80px;" class="breakdown-place" value="2nd">
                            <input type="number" placeholder="4500" style="width: 100px;" class="breakdown-amount" value="">
                            <span style="color: #888;">USD</span>
                            <input type="number" placeholder="30" style="width: 80px;" class="breakdown-percent" value="30" min="1" max="100">
                            <span style="color: #888;">%</span>
                            <button type="button" onclick="removePrizeItem(this)" style="background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">‚úï</button>
                        </div>
                        <div class="prize-breakdown-item" style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                            <input type="text" placeholder="3rd" style="width: 80px;" class="breakdown-place" value="3rd">
                            <input type="number" placeholder="3000" style="width: 100px;" class="breakdown-amount" value="">
                            <span style="color: #888;">USD</span>
                            <input type="number" placeholder="20" style="width: 80px;" class="breakdown-percent" value="20" min="1" max="100">
                            <span style="color: #888;">%</span>
                            <button type="button" onclick="removePrizeItem(this)" style="background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">‚úï</button>
                        </div>
                    `;
                    
                    loadCompetitions();
                } else {
                    throw new Error('Failed to create competition');
                }
            } catch (error) {
                showMessage('Error creating competition: ' + error.message, 'error');
            }
        }

        async function addWinner(e) {
            e.preventDefault();
            
            const winner = {
                competition_id: document.getElementById('winner-competition').value,
                place: parseInt(document.getElementById('winner-place').value),
                username: document.getElementById('winner-username').value,
                amount_usd: parseInt(document.getElementById('winner-amount').value),
                tx_url: document.getElementById('winner-tx').value
            };
            
            try {
                const response = await authenticatedFetch('/api/winners', {
                    method: 'POST',
                    body: JSON.stringify(winner)
                });
                
                if (response.ok) {
                    showMessage('Winner added successfully!', 'success');
                    e.target.reset();
                } else {
                    throw new Error('Failed to add winner');
                }
            } catch (error) {
                showMessage('Error adding winner: ' + error.message, 'error');
            }
        }

        async function loadSystemStats() {
            const statsEl = document.getElementById('system-stats');
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                statsEl.innerHTML = `
                    <div class="stats-row">
                        <div class="stat-item">
                            <div class="stat-value">$${stats.total_distributed.toLocaleString()}</div>
                            <div class="stat-label">Total Distributed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.total_winners}</div>
                            <div class="stat-label">Winners Paid</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.months_active}</div>
                            <div class="stat-label">Months Active</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('cache-version').value = stats.cache_version;
            } catch (error) {
                statsEl.innerHTML = '<div class="error">Failed to load stats</div>';
            }
        }

        async function updateCacheVersion() {
            const version = document.getElementById('cache-version').value;
            try {
                const response = await authenticatedFetch('/api/settings', {
                    method: 'PUT',
                    body: JSON.stringify({ key: 'cache_version', value: version })
                });
                
                if (response.ok) {
                    showMessage('Cache version updated! Frontend will refresh.', 'success');
                } else {
                    throw new Error('Failed to update cache version');
                }
            } catch (error) {
                showMessage('Error updating cache: ' + error.message, 'error');
            }
        }

        function showMessage(text, type) {
            const messageArea = document.getElementById('message-area');
            messageArea.innerHTML = `<div class="${type}">${text}</div>`;
            setTimeout(() => messageArea.innerHTML = '', 5000);
        }
    </script>
</body>
</html>