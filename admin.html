<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpyFly Admin - Prize Management</title>
    <link rel="stylesheet" href="styles.css?v=202509">
    <style>
        .admin-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .admin-header { background: var(--darker-bg); padding: 30px; border-radius: 12px; margin-bottom: 30px; text-align: center; }
        .admin-card { background: var(--darker-bg); border-radius: 12px; padding: 25px; border: 1px solid rgba(45, 212, 127, 0.3); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; color: #ffffff; margin-bottom: 8px; font-weight: 600; }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; 
            background: var(--dark-bg); 
            border: 1px solid rgba(45, 212, 127, 0.3); 
            border-radius: 6px; 
            padding: 12px; 
            color: #ffffff; 
            font-size: 14px;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        .btn-admin { background: var(--primary-color); color: #ffffff; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-right: 10px; transition: all 0.3s; }
        .btn-admin:hover { background: #22c55e; }
        .btn-danger { background: #dc2626; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-warning { background: #f59e0b; }
        .btn-warning:hover { background: #d97706; }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }
        .loading { text-align: center; padding: 40px; color: var(--primary-color); }
        .error { background: #dc2626; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .success { background: #22c55e; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        
        /* Tab System */
        .control-tabs { display: flex; gap: 5px; background: rgba(45, 212, 127, 0.1); padding: 5px; border-radius: 10px; margin-bottom: 30px; }
        .tab-btn { background: transparent; border: none; color: rgba(255, 255, 255, 0.7); padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .tab-btn.active, .tab-btn:hover { background: var(--primary-color); color: white; }
        .tab-content { display: none; }
        
        /* Modal Styles */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--darker-bg); border: 1px solid rgba(45, 212, 127, 0.3); border-radius: 12px; width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid rgba(45, 212, 127, 0.2); }
        .modal-header h3 { margin: 0; color: var(--primary-color); }
        .modal-close { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 5px; }
        .modal-close:hover { color: var(--primary-color); }
        .modal-body { padding: 20px; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        
        /* Table Styles */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { padding: 15px; text-align: left; border-bottom: 1px solid rgba(45, 212, 127, 0.2); }
        .data-table th { color: var(--primary-color); font-weight: 600; background: rgba(45, 212, 127, 0.05); }
        .data-table tr:hover { background: rgba(45, 212, 127, 0.05); }
        .data-table .btn-small { padding: 6px 12px; font-size: 0.85rem; }
        
        /* Status Badges */
        .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; display: inline-block; }
        .status-active { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .status-upcoming { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .status-ended { background: rgba(156, 163, 175, 0.2); color: #9ca3af; }
        .status-pending { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .status-approved { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .status-disqualified { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        
        /* KPI Cards */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .kpi-card { background: rgba(45, 212, 127, 0.1); border: 1px solid rgba(45, 212, 127, 0.3); border-radius: 10px; padding: 20px; text-align: center; }
        .kpi-card h4 { color: var(--primary-color); font-size: 0.9rem; margin-bottom: 10px; font-weight: 600; }
        .kpi-value { font-size: 2rem; font-weight: 700; color: white; }
        
        /* Winner Approval Section */
        .winner-list { max-height: 400px; overflow-y: auto; }
        .winner-item { background: rgba(45, 212, 127, 0.05); border: 1px solid rgba(45, 212, 127, 0.2); border-radius: 8px; padding: 15px; margin-bottom: 10px; }
        .winner-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .winner-info { display: flex; gap: 20px; flex-wrap: wrap; font-size: 0.9rem; }
        .winner-actions { display: flex; gap: 10px; margin-top: 10px; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .stat-card { background: rgba(45, 212, 127, 0.05); border: 1px solid rgba(45, 212, 127, 0.2); border-radius: 10px; padding: 20px; }
        .stat-card h4 { color: var(--primary-color); margin-bottom: 15px; }
        .stat-item { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .stat-label { color: rgba(255, 255, 255, 0.7); }
        .stat-value { color: white; font-weight: 600; }
        
        /* User Filter */
        .filter-section { background: rgba(45, 212, 127, 0.05); padding: 20px; border-radius: 10px; margin-bottom: 25px; }
        
        @media (max-width: 768px) { 
            .admin-container { padding: 15px; }
            .control-tabs { flex-wrap: wrap; }
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .data-table { font-size: 0.85rem; }
            .modal-content { width: 95%; }
        }
    </style>
</head>
<body class="admin-page" style="background: var(--dark-bg); color: #ffffff; min-height: 100vh;">
    <!-- Authentication Check Overlay -->
    <div id="auth-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 18, 19, 0.95); display: flex; align-items: center; justify-content: center; z-index: 9999;">
        <div style="text-align: center; color: #2DD47F;">
            <div class="loading" style="width: 40px; height: 40px; margin: 0 auto 20px;"></div>
            <h2>üîê Verifying Access</h2>
            <p>Please wait while we authenticate your session...</p>
        </div>
    </div>
    
    <div class="admin-container" id="admin-content" style="display: none;">
        <div class="admin-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>üèÜ SpyFly Prize Management</h1>
                    <p style="margin: 5px 0 0 0;">Manage competitions, prizes, and winners</p>
                </div>
                <div style="text-align: right;">
                    <p style="margin: 0; color: #2DD47F; font-size: 14px;">Welcome, <span id="admin-username">admin</span></p>
                    <button onclick="logout()" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; margin-top: 5px;">Logout</button>
                </div>
            </div>
        </div>

        <div id="message-area"></div>

        <!-- MAIN LEADERBOARD TOGGLE - Prominent Position -->
        <div class="admin-card" style="background: linear-gradient(135deg, rgba(45, 212, 127, 0.1), rgba(45, 212, 127, 0.05)); border: 2px solid rgba(45, 212, 127, 0.4); margin-bottom: 30px;">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                <div>
                    <h3 style="margin: 0; color: var(--primary-color); display: flex; align-items: center; gap: 10px;">
                        üéØ <span>Production Leaderboard Control</span>
                    </h3>
                    <p style="margin: 5px 0 0 0; color: rgba(255,255,255,0.7); font-size: 0.9rem;">
                        Master switch for all leaderboard features on the website
                    </p>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <select id="leaderboard-toggle" style="padding: 12px; background: var(--dark-bg); border: 2px solid var(--primary-color); border-radius: 8px; color: white; font-weight: 600;">
                        <option value="true">üü¢ ON - Full leaderboard features enabled</option>
                        <option value="false">üî¥ OFF - Hide all leaderboard elements</option>
                    </select>
                    <button class="btn-admin" onclick="updateLeaderboardToggle()">
                        Update Control
                    </button>
                </div>
            </div>
            <div style="margin-top: 10px; padding: 10px; background: rgba(45, 212, 127, 0.05); border-radius: 6px; border-left: 4px solid var(--primary-color);">
                <small style="color: rgba(255,255,255,0.8); font-style: italic;">
                    ‚ÑπÔ∏è <strong>OFF:</strong> Clean conversion landing page (hides hero banner, leaderboard section, navigation buttons)<br>
                    ‚ÑπÔ∏è <strong>ON:</strong> Full sophisticated leaderboard app with competitions and prize displays
                </small>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="control-tabs">
            <button class="tab-btn active" onclick="switchTab('competitions')">üèÜ Competitions</button>
            <button class="tab-btn" onclick="switchTab('statistics')">üìä System Statistics</button>
        </div>

        <!-- COMPETITIONS TAB -->
        <div class="tab-content" id="tab-competitions" style="display: block;">
            <div class="admin-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">üèÜ Competition Management</h3>
                    <button class="btn-admin" onclick="openCreateCompetitionModal()">
                        ‚ûï Create New Competition
                    </button>
                </div>
                
                <div id="competitions-loading" class="loading">Loading competitions...</div>
                <div id="competitions-table-container" style="display: none;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Competition</th>
                                <th>Period</th>
                                <th>Status</th>
                                <th>Type</th>
                                <th>Prize Pool</th>
                                <th>Participants</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="competitions-list">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SYSTEM STATISTICS TAB -->
        <div class="tab-content" id="tab-statistics" style="display: none;">
            <div class="admin-card">
                <h3>üìä System Statistics</h3>
                
                <!-- Overall KPIs -->
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <h4>Total Competitions</h4>
                        <div id="stat-total-comps" class="kpi-value">-</div>
                    </div>
                    <div class="kpi-card">
                        <h4>Total Prize Pool Deployed</h4>
                        <div id="stat-total-prizes" class="kpi-value">-</div>
                    </div>
                    <div class="kpi-card">
                        <h4>Total Winners Approved</h4>
                        <div id="stat-total-winners" class="kpi-value">-</div>
                    </div>
                    <div class="kpi-card">
                        <h4>Unique Participants</h4>
                        <div id="stat-unique-users" class="kpi-value">-</div>
                    </div>
                </div>

                <!-- User Participation Filter -->
                <div class="filter-section">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">üîç User Participation Lookup</h4>
                    <div style="display: flex; gap: 15px; align-items: flex-end;">
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label>Search by Username or Wallet</label>
                            <input type="text" id="user-search" placeholder="Enter username or wallet address">
                        </div>
                        <button class="btn-admin" onclick="searchUserStats()">Search</button>
                    </div>
                </div>

                <!-- User Stats Results -->
                <div id="user-stats-container" style="display: none; margin-top: 25px;">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">User Statistics</h4>
                    <div class="stats-grid" id="user-stats-grid"></div>
                </div>

                <!-- Competition Breakdown -->
                <div style="margin-top: 30px;">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">üìà Competition Type Breakdown</h4>
                    <div class="stats-grid" id="comp-type-stats"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- CREATE COMPETITION MODAL -->
    <div id="create-competition-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üéØ Create New Competition</h3>
                <button class="modal-close" onclick="closeModal('create-competition-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="competition-form" onsubmit="createCompetition(event)">
                    <div class="form-group">
                        <label>Competition Name (ID)</label>
                        <input type="text" id="comp-name" placeholder="e.g., oct2025" required>
                        <small style="color: rgba(255,255,255,0.6);">Unique identifier (lowercase, no spaces)</small>
                    </div>
                    <div class="form-group">
                        <label>Display Title</label>
                        <input type="text" id="comp-title" placeholder="e.g., October Trading Championship" required>
                    </div>
                    <div class="form-group">
                        <label>Period Display</label>
                        <input type="text" id="comp-period" placeholder="e.g., October 2025" required>
                    </div>
                    <div class="form-group">
                        <label>Competition Type</label>
                        <select id="comp-type" required>
                            <option value="">Select Type</option>
                            <option value="pnl">üí∞ P&L Competition</option>
                            <option value="volume">üìä Volume Competition</option>
                            <option value="winrate">üéØ Win Rate Competition</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="datetime-local" id="comp-start" required>
                    </div>
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="datetime-local" id="comp-end" required>
                    </div>
                    <div class="form-group">
                        <label>Prize Pool (USD)</label>
                        <input type="number" id="comp-pool" placeholder="15000" required>
                    </div>
                    <div class="form-group">
                        <label>Prize Structure (JSON)</label>
                        <textarea id="comp-prizes" rows="6" required>{"1": 7500, "2": 4500, "3": 2250, "4": 750}</textarea>
                        <small style="color: rgba(255,255,255,0.6);">Format: {"position": amount}</small>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeModal('create-competition-modal')">Cancel</button>
                        <button type="submit" class="btn-admin">Create Competition</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- COMPETITION DETAIL MODAL -->
    <div id="competition-detail-modal" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h3 id="detail-modal-title">Competition Details</h3>
                <button class="modal-close" onclick="closeModal('competition-detail-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Competition Info -->
                <div style="background: rgba(45, 212, 127, 0.05); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div id="competition-info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    </div>
                </div>

                <!-- Tabs within modal -->
                <div style="border-bottom: 2px solid rgba(45, 212, 127, 0.2); margin-bottom: 20px;">
                    <button class="tab-btn active" onclick="switchDetailTab('participants')" id="tab-btn-participants">üë• Participants</button>
                    <button class="tab-btn" onclick="switchDetailTab('prizes')" id="tab-btn-prizes">üí∞ Prizes</button>
                    <button class="tab-btn" onclick="switchDetailTab('winners')" id="tab-btn-winners">üëë Winners</button>
                </div>

                <!-- Participants Tab -->
                <div id="detail-tab-participants" class="detail-subtab" style="display: block;">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">Leaderboard Participants</h4>
                    <div id="participants-loading" class="loading">Loading participants...</div>
                    <table class="data-table" id="participants-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Username</th>
                                <th>Wallet</th>
                                <th>Score</th>
                                <th>Prize Position</th>
                            </tr>
                        </thead>
                        <tbody id="participants-list"></tbody>
                    </table>
                </div>

                <!-- Prizes Tab -->
                <div id="detail-tab-prizes" class="detail-subtab" style="display: none;">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">Prize Distribution</h4>
                    <table class="data-table" id="prizes-table">
                        <thead>
                            <tr>
                                <th>Position</th>
                                <th>Prize Amount</th>
                                <th>Status</th>
                                <th>Winner</th>
                            </tr>
                        </thead>
                        <tbody id="prizes-list"></tbody>
                    </table>
                </div>

                <!-- Winners Tab -->
                <div id="detail-tab-winners" class="detail-subtab" style="display: none;">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">Winner Selection & Approval</h4>
                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 20px;">
                        Winners are determined from API leaderboard data. Review and approve each winner before finalizing prize positions.
                    </p>
                    
                    <div id="winners-loading" class="loading">Loading winner selection...</div>
                    <div id="winners-list" class="winner-list" style="display: none;"></div>
                </div>

                <div class="modal-actions" style="margin-top: 25px;">
                    <button class="btn-danger" onclick="confirmDeleteCompetition()">Delete Competition</button>
                    <button class="btn-secondary" onclick="closeModal('competition-detail-modal')">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let competitions = [];
        let currentCompetitionId = null;
        let currentDetailTab = 'participants';

        // Authentication Check
        async function checkAuth() {
            try {
                const response = await fetch(`${API_URL}/auth/check`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('admin-username').textContent = data.username || 'admin';
                    document.getElementById('auth-overlay').style.display = 'none';
                    document.getElementById('admin-content').style.display = 'block';
                    
                    loadInitialData();
                } else {
                    window.location.href = '/login.html';
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/login.html';
            }
        }

        async function logout() {
            try {
                await fetch(`${API_URL}/auth/logout`, { 
                    method: 'POST',
                    credentials: 'include' 
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            window.location.href = '/login.html';
        }

        // Load Initial Data
        async function loadInitialData() {
            await loadLeaderboardToggle();
            await loadCompetitions();
            await loadSystemStatistics();
        }

        // Leaderboard Toggle
        async function loadLeaderboardToggle() {
            try {
                const response = await fetch(`${API_URL}/leaderboard-toggle`);
                const data = await response.json();
                document.getElementById('leaderboard-toggle').value = data.enabled.toString();
            } catch (error) {
                console.error('Error loading toggle:', error);
            }
        }

        async function updateLeaderboardToggle() {
            const enabled = document.getElementById('leaderboard-toggle').value === 'true';
            try {
                const response = await fetch(`${API_URL}/leaderboard-toggle`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ enabled })
                });
                
                if (response.ok) {
                    showMessage('Leaderboard control updated successfully!', 'success');
                } else {
                    showMessage('Failed to update leaderboard control', 'error');
                }
            } catch (error) {
                console.error('Error updating toggle:', error);
                showMessage('Error updating leaderboard control', 'error');
            }
        }

        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).style.display = 'block';
            
            if (tabName === 'statistics') {
                loadSystemStatistics();
            }
        }

        function switchDetailTab(tabName) {
            document.querySelectorAll('#competition-detail-modal .tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.detail-subtab').forEach(content => content.style.display = 'none');
            
            document.getElementById(`tab-btn-${tabName}`).classList.add('active');
            document.getElementById(`detail-tab-${tabName}`).style.display = 'block';
            currentDetailTab = tabName;
            
            if (tabName === 'participants') {
                loadParticipants();
            } else if (tabName === 'prizes') {
                loadPrizes();
            } else if (tabName === 'winners') {
                loadWinners();
            }
        }

        // Modal Management
        function openCreateCompetitionModal() {
            document.getElementById('create-competition-modal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function openCompetitionDetail(competitionId) {
            currentCompetitionId = competitionId;
            const comp = competitions.find(c => c.id === competitionId);
            if (!comp) return;
            
            document.getElementById('detail-modal-title').textContent = comp.title;
            
            const infoGrid = document.getElementById('competition-info-grid');
            infoGrid.innerHTML = `
                <div><strong style="color: var(--primary-color);">Period:</strong> ${comp.period}</div>
                <div><strong style="color: var(--primary-color);">Type:</strong> ${getTypeLabel(comp.type)}</div>
                <div><strong style="color: var(--primary-color);">Status:</strong> ${getStatusBadge(comp)}</div>
                <div><strong style="color: var(--primary-color);">Prize Pool:</strong> $${comp.prize_pool.toLocaleString()}</div>
                <div><strong style="color: var(--primary-color);">Start:</strong> ${new Date(comp.start_date).toLocaleDateString()}</div>
                <div><strong style="color: var(--primary-color);">End:</strong> ${new Date(comp.end_date).toLocaleDateString()}</div>
            `;
            
            document.getElementById('competition-detail-modal').classList.add('active');
            currentDetailTab = 'participants';
            switchDetailTab('participants');
        }

        // Competitions Management
        async function loadCompetitions() {
            try {
                const response = await fetch(`${API_URL}/competitions`);
                competitions = await response.json();
                
                document.getElementById('competitions-loading').style.display = 'none';
                document.getElementById('competitions-table-container').style.display = 'block';
                
                const tbody = document.getElementById('competitions-list');
                tbody.innerHTML = competitions.map(comp => `
                    <tr>
                        <td><strong style="color: var(--primary-color);">${comp.title}</strong></td>
                        <td>${comp.period}</td>
                        <td>${getStatusBadge(comp)}</td>
                        <td>${getTypeLabel(comp.type)}</td>
                        <td>$${comp.prize_pool.toLocaleString()}</td>
                        <td>${comp.participant_count || 0}</td>
                        <td>
                            <button class="btn-admin btn-small" onclick="openCompetitionDetail('${comp.id}')">
                                View Details
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading competitions:', error);
                showMessage('Failed to load competitions', 'error');
            }
        }

        async function createCompetition(event) {
            event.preventDefault();
            
            const competitionData = {
                id: document.getElementById('comp-name').value,
                title: document.getElementById('comp-title').value,
                period: document.getElementById('comp-period').value,
                type: document.getElementById('comp-type').value,
                start_date: document.getElementById('comp-start').value,
                end_date: document.getElementById('comp-end').value,
                prize_pool: parseInt(document.getElementById('comp-pool').value),
                prize_structure: JSON.parse(document.getElementById('comp-prizes').value)
            };

            try {
                const response = await fetch(`${API_URL}/competitions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(competitionData)
                });

                if (response.ok) {
                    showMessage('Competition created successfully!', 'success');
                    closeModal('create-competition-modal');
                    document.getElementById('competition-form').reset();
                    await loadCompetitions();
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Failed to create competition', 'error');
                }
            } catch (error) {
                console.error('Error creating competition:', error);
                showMessage('Error creating competition', 'error');
            }
        }

        async function confirmDeleteCompetition() {
            if (!confirm('Are you sure you want to delete this competition? This action cannot be undone.')) return;
            
            try {
                const response = await fetch(`${API_URL}/competitions/${currentCompetitionId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    showMessage('Competition deleted successfully', 'success');
                    closeModal('competition-detail-modal');
                    await loadCompetitions();
                } else {
                    showMessage('Failed to delete competition', 'error');
                }
            } catch (error) {
                console.error('Error deleting competition:', error);
                showMessage('Error deleting competition', 'error');
            }
        }

        // Participants Management
        async function loadParticipants() {
            document.getElementById('participants-loading').style.display = 'block';
            document.getElementById('participants-table').style.display = 'none';
            
            try {
                const response = await fetch(`${API_URL}/leaderboard/${currentCompetitionId}`);
                const participants = await response.json();
                
                document.getElementById('participants-loading').style.display = 'none';
                document.getElementById('participants-table').style.display = 'table';
                
                const tbody = document.getElementById('participants-list');
                tbody.innerHTML = participants.map(p => `
                    <tr>
                        <td><strong>${p.rank}</strong></td>
                        <td>${p.username}</td>
                        <td><code style="font-size: 0.85rem;">${p.wallet_address.substring(0, 8)}...${p.wallet_address.substring(p.wallet_address.length - 6)}</code></td>
                        <td><strong style="color: var(--primary-color);">${formatScore(p.score, p.competition_type)}</strong></td>
                        <td>${p.prize_position ? `Position #${p.prize_position}` : '-'}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading participants:', error);
                showMessage('Failed to load participants', 'error');
            }
        }

        // Prizes Management
        async function loadPrizes() {
            const comp = competitions.find(c => c.id === currentCompetitionId);
            if (!comp) return;
            
            const tbody = document.getElementById('prizes-list');
            const prizeEntries = Object.entries(comp.prize_structure).sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
            
            tbody.innerHTML = prizeEntries.map(([position, amount]) => `
                <tr>
                    <td><strong>#${position}</strong></td>
                    <td><strong style="color: var(--primary-color);">$${amount.toLocaleString()}</strong></td>
                    <td><span class="status-badge status-pending">Awaiting Approval</span></td>
                    <td>-</td>
                </tr>
            `).join('');
        }

        // Winners Management
        async function loadWinners() {
            document.getElementById('winners-loading').style.display = 'block';
            document.getElementById('winners-list').style.display = 'none';
            
            try {
                const response = await fetch(`${API_URL}/leaderboard/${currentCompetitionId}`);
                const leaderboardData = await response.json();
                
                const comp = competitions.find(c => c.id === currentCompetitionId);
                const prizePositions = Object.keys(comp.prize_structure).map(Number).sort((a, b) => a - b);
                
                const winnersResponse = await fetch(`${API_URL}/winners?competition_id=${currentCompetitionId}`);
                const existingWinners = await winnersResponse.json();
                
                document.getElementById('winners-loading').style.display = 'none';
                document.getElementById('winners-list').style.display = 'block';
                
                const winnersList = document.getElementById('winners-list');
                winnersList.innerHTML = prizePositions.map(position => {
                    const participant = leaderboardData.find(p => p.rank === position);
                    const existingWinner = existingWinners.find(w => w.prize_position === position);
                    
                    if (!participant) {
                        return `
                            <div class="winner-item">
                                <div class="winner-header">
                                    <h4 style="color: var(--primary-color); margin: 0;">Position #${position} - $${comp.prize_structure[position].toLocaleString()}</h4>
                                    <span class="status-badge status-pending">No Participant</span>
                                </div>
                                <p style="color: rgba(255,255,255,0.6); margin: 10px 0 0 0;">No participant at this rank</p>
                            </div>
                        `;
                    }
                    
                    const status = existingWinner?.status || 'pending';
                    const isDisqualified = existingWinner?.status === 'disqualified';
                    
                    return `
                        <div class="winner-item">
                            <div class="winner-header">
                                <h4 style="color: var(--primary-color); margin: 0;">Position #${position} - $${comp.prize_structure[position].toLocaleString()}</h4>
                                <span class="status-badge status-${status}">${status.toUpperCase()}</span>
                            </div>
                            <div class="winner-info">
                                <div><strong>Username:</strong> ${participant.username}</div>
                                <div><strong>Wallet:</strong> <code>${participant.wallet_address.substring(0, 12)}...${participant.wallet_address.substring(participant.wallet_address.length - 8)}</code></div>
                                <div><strong>Score:</strong> ${formatScore(participant.score, comp.type)}</div>
                                <div><strong>Rank:</strong> #${participant.rank}</div>
                            </div>
                            <div class="winner-actions">
                                ${status === 'pending' ? `
                                    <button class="btn-admin" onclick="approveWinner('${participant.wallet_address}', ${position})">
                                        ‚úì Approve Winner
                                    </button>
                                    <button class="btn-danger" onclick="disqualifyWinner('${participant.wallet_address}', ${position})">
                                        ‚úó Disqualify
                                    </button>
                                ` : status === 'approved' ? `
                                    <button class="btn-warning" onclick="revokeApproval('${participant.wallet_address}', ${position})">
                                        Revoke Approval
                                    </button>
                                ` : `
                                    <button class="btn-admin" onclick="reinstateWinner('${participant.wallet_address}', ${position})">
                                        Reinstate
                                    </button>
                                `}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading winners:', error);
                showMessage('Failed to load winner selection', 'error');
            }
        }

        async function approveWinner(walletAddress, position) {
            try {
                const response = await fetch(`${API_URL}/winners/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        competition_id: currentCompetitionId,
                        wallet_address: walletAddress,
                        prize_position: position
                    })
                });

                if (response.ok) {
                    showMessage('Winner approved successfully!', 'success');
                    await loadWinners();
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Failed to approve winner', 'error');
                }
            } catch (error) {
                console.error('Error approving winner:', error);
                showMessage('Error approving winner', 'error');
            }
        }

        async function disqualifyWinner(walletAddress, position) {
            if (!confirm('Are you sure you want to disqualify this participant? The next runner-up will automatically be pre-qualified.')) return;
            
            try {
                const response = await fetch(`${API_URL}/winners/disqualify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        competition_id: currentCompetitionId,
                        wallet_address: walletAddress,
                        prize_position: position
                    })
                });

                if (response.ok) {
                    showMessage('Participant disqualified. Next runner-up pre-qualified for approval.', 'success');
                    await loadWinners();
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Failed to disqualify participant', 'error');
                }
            } catch (error) {
                console.error('Error disqualifying:', error);
                showMessage('Error processing disqualification', 'error');
            }
        }

        async function revokeApproval(walletAddress, position) {
            if (!confirm('Revoke approval for this winner?')) return;
            
            try {
                const response = await fetch(`${API_URL}/winners/revoke`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        competition_id: currentCompetitionId,
                        wallet_address: walletAddress,
                        prize_position: position
                    })
                });

                if (response.ok) {
                    showMessage('Approval revoked', 'success');
                    await loadWinners();
                } else {
                    showMessage('Failed to revoke approval', 'error');
                }
            } catch (error) {
                console.error('Error revoking approval:', error);
                showMessage('Error revoking approval', 'error');
            }
        }

        async function reinstateWinner(walletAddress, position) {
            try {
                const response = await fetch(`${API_URL}/winners/reinstate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        competition_id: currentCompetitionId,
                        wallet_address: walletAddress,
                        prize_position: position
                    })
                });

                if (response.ok) {
                    showMessage('Participant reinstated', 'success');
                    await loadWinners();
                } else {
                    showMessage('Failed to reinstate participant', 'error');
                }
            } catch (error) {
                console.error('Error reinstating:', error);
                showMessage('Error reinstating participant', 'error');
            }
        }

        // System Statistics
        async function loadSystemStatistics() {
            try {
                const [compsRes, winnersRes] = await Promise.all([
                    fetch(`${API_URL}/competitions`),
                    fetch(`${API_URL}/winners`)
                ]);
                
                const allCompetitions = await compsRes.json();
                const allWinners = await winnersRes.json();
                
                const totalPrizes = allCompetitions.reduce((sum, c) => sum + c.prize_pool, 0);
                const approvedWinners = allWinners.filter(w => w.status === 'approved').length;
                
                document.getElementById('stat-total-comps').textContent = allCompetitions.length;
                document.getElementById('stat-total-prizes').textContent = `$${totalPrizes.toLocaleString()}`;
                document.getElementById('stat-total-winners').textContent = approvedWinners;
                document.getElementById('stat-unique-users').textContent = '...';
                
                const typeBreakdown = {};
                allCompetitions.forEach(comp => {
                    typeBreakdown[comp.type] = (typeBreakdown[comp.type] || 0) + 1;
                });
                
                const typeStatsHTML = Object.entries(typeBreakdown).map(([type, count]) => `
                    <div class="stat-card">
                        <h4>${getTypeLabel(type)}</h4>
                        <div class="stat-item">
                            <span class="stat-label">Total Competitions:</span>
                            <span class="stat-value">${count}</span>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('comp-type-stats').innerHTML = typeStatsHTML;
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        async function searchUserStats() {
            const searchTerm = document.getElementById('user-search').value.trim();
            if (!searchTerm) {
                showMessage('Please enter a username or wallet address', 'error');
                return;
            }
            
            document.getElementById('user-stats-container').style.display = 'block';
            document.getElementById('user-stats-grid').innerHTML = '<div class="loading">Searching...</div>';
            
            try {
                const response = await fetch(`${API_URL}/user-stats?search=${encodeURIComponent(searchTerm)}`);
                if (!response.ok) throw new Error('Search failed');
                
                const stats = await response.json();
                
                document.getElementById('user-stats-grid').innerHTML = `
                    <div class="stat-card">
                        <h4>Competitions Participated</h4>
                        <div class="stat-item">
                            <span class="stat-value">${stats.competitions_count || 0}</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h4>Total Winnings</h4>
                        <div class="stat-item">
                            <span class="stat-value">$${(stats.total_winnings || 0).toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h4>Best Rank</h4>
                        <div class="stat-item">
                            <span class="stat-value">#${stats.best_rank || '-'}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error searching user stats:', error);
                document.getElementById('user-stats-grid').innerHTML = '<p style="color: rgba(255,255,255,0.6);">No data found for this user.</p>';
            }
        }

        // Utility Functions
        function getStatusBadge(comp) {
            const now = new Date();
            const start = new Date(comp.start_date);
            const end = new Date(comp.end_date);
            
            if (now < start) {
                return '<span class="status-badge status-upcoming">UPCOMING</span>';
            } else if (now >= start && now <= end) {
                return '<span class="status-badge status-active">ACTIVE</span>';
            } else {
                return '<span class="status-badge status-ended">ENDED</span>';
            }
        }

        function getTypeLabel(type) {
            const labels = {
                'pnl': 'üí∞ P&L',
                'volume': 'üìä Volume',
                'winrate': 'üéØ Win Rate'
            };
            return labels[type] || type;
        }

        function formatScore(score, type) {
            if (type === 'pnl') return `$${score.toLocaleString()}`;
            if (type === 'volume') return `$${score.toLocaleString()}`;
            if (type === 'winrate') return `${score}%`;
            return score.toLocaleString();
        }

        function showMessage(text, type) {
            const messageArea = document.getElementById('message-area');
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = text;
            messageArea.innerHTML = '';
            messageArea.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        checkAuth();
    </script>
</body>
</html>
