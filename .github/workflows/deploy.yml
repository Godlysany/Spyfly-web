name: SpyFly Database Sync

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  database-sync:
    name: Sync Supabase Database
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ— Checkout code
        uses: actions/checkout@v4

      - name: ðŸ—„ Check for Database Changes
        id: check-migration
        run: |
          if [ -f "migrations.sql" ]; then
            echo "âœ… Migration file found - will sync database"
            echo "has_migration=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No migration file found - skipping database sync"
            echo "has_migration=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸš€ Apply Database Migration
        if: steps.check-migration.outputs.has_migration == 'true'
        run: |
          echo "ðŸ—„ Connecting to Supabase database..."
          # Install PostgreSQL client
          sudo apt-get update -q
          sudo apt-get install -y postgresql-client
          
          # Apply migration using DATABASE_URL
          echo "ðŸ“ Applying migration to database..."
          psql "${{ secrets.DATABASE_URL }}" -f migrations.sql -v ON_ERROR_STOP=1
          
          echo "âœ… Database migration completed successfully!"

      - name: ðŸ“¦ Archive Migration File
        if: steps.check-migration.outputs.has_migration == 'true'
        run: |
          # Create archive directory
          mkdir -p applied-migrations
          
          # Move migration file with timestamp
          timestamp=$(date +%Y%m%d_%H%M%S)
          mv migrations.sql "applied-migrations/migration-${timestamp}.sql"
          
          # Configure git and commit the archived migration
          git config --global user.name 'SpyFly Database Sync'
          git config --global user.email 'dbsync@spyfly.com'
          git add applied-migrations/
          
          if ! git diff --staged --quiet; then
            git commit -m "ðŸ“¦ Archive database migration ${timestamp}"
            git push origin ${{ github.ref_name }}
            echo "ðŸ—ƒï¸ Migration archived successfully"
          else
            echo "â„¹ï¸ No changes to archive"
          fi

      - name: ðŸ“Š Migration Summary
        if: steps.check-migration.outputs.has_migration == 'true'
        run: |
          echo "## ðŸ—„ï¸ SpyFly Database Migration Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY  
          echo "**âœ… Status:** Migration Applied Successfully" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ•’ Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ—ƒï¸ Archive:** Migration moved to applied-migrations/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸ Railway will auto-deploy your application changes." >> $GITHUB_STEP_SUMMARY

      - name: â„¹ï¸ No Changes
        if: steps.check-migration.outputs.has_migration == 'false'
        run: |
          echo "## â„¹ï¸ No Database Changes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No migrations.sql file found - database sync skipped." >> $GITHUB_STEP_SUMMARY
          echo "Railway will still auto-deploy any application changes." >> $GITHUB_STEP_SUMMARY